<!DOCTYPE html>
<html lang="ja">
<!-- Version: 4.17.0 -->
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>ãƒ›ãƒ­ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
  <link rel="stylesheet" href="css/google-drive-sync.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #333;
    }

    .container {
      max-width: 600px;
      width: 90%;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      padding: 40px;
      text-align: center;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    h1 {
      font-size: 2.2em;
      margin: 20px 0;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      font-weight: bold;
    }

    .subtitle {
      font-size: 1.1em;
      color: #666;
      margin-bottom: 40px;
      line-height: 1.6;
    }

    .menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .menu-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border: 2px solid transparent;
      border-radius: 15px;
      padding: 30px 20px;
      text-decoration: none;
      color: #333;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    .menu-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      transition: left 0.5s;
    }

    .menu-card:hover::before {
      left: 100%;
    }

    .menu-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
      border-color: #667eea;
    }

    .menu-icon {
      font-size: 3em;
      margin-bottom: 15px;
      display: block;
    }

    .menu-title {
      font-size: 1.4em;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }

    .menu-description {
      font-size: 0.95em;
      color: #666;
      line-height: 1.5;
    }

    .footer {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      color: #888;
      font-size: 0.9em;
    }

    /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
    @media (max-width: 768px) {
      .container {
        padding: 30px 20px;
        margin: 20px;
      }

      h1 {
        font-size: 1.8em;
      }

      .subtitle {
        font-size: 1em;
      }

      .menu-grid {
        grid-template-columns: 1fr;
      }

      .menu-card {
        padding: 25px 15px;
      }

      .menu-icon {
        font-size: 2.5em;
      }

      .menu-title {
        font-size: 1.2em;
      }
      
      /* ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã®ã¿ã§ç”»åƒä¸€æ‹¬DLãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º */
      .mobile-only {
        display: inline-block !important;
      }
    }

    /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç‰ˆã§ã¯ç”»åƒä¸€æ‹¬DLãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º */
    @media (min-width: 769px) {
      .mobile-only {
        display: none !important;
      }
    }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
    @media (prefers-color-scheme: dark) {
      body {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      }

      .container {
        background: rgba(44, 62, 80, 0.95);
        color: #ecf0f1;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .menu-card {
        background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
        color: #ecf0f1;
      }

      .menu-card:hover {
        border-color: #3498db;
      }

      .menu-title {
        color: #ecf0f1;
      }

      .menu-description {
        color: #bdc3c7;
      }

      .subtitle {
        color: #bdc3c7;
      }

      h1 span {
        color: #95a5a6 !important;
      }

      .footer {
        color: #95a5a6;
        border-top-color: rgba(255, 255, 255, 0.1);
      }
    }

    /* èª­ã¿å–ã‚Šå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */
    .toggle-switch input:checked + .toggle-slider {
      background: linear-gradient(45deg, #dc3545, #c82333) !important;
    }

    .toggle-switch .toggle-slider:before {
      content: "";
      position: absolute;
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(28px);
    }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®èª­ã¿å–ã‚Šå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    @media (prefers-color-scheme: dark) {
      .toggle-switch .toggle-slider {
        background-color: #4a5568 !important;
      }

      .toggle-switch input:checked + .toggle-slider {
        background: linear-gradient(45deg, #e53e3e, #c53030) !important;
      }
    }

    /* æ›´æ–°ç¢ºèªãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #updateCheckBtn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }

    #updateCheckBtn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    /* ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #driveExportBtn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
    }

    #driveExportBtn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    /* ç”»åƒä¸€æ‹¬DLãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #imageBulkDownloadBtn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
    }

    #imageBulkDownloadBtn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    /* ä»–äººã®ã‚¹ãƒˆãƒ¬ã‚¤ã‚¸é–²è¦§ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #viewingOtherStorageSection {
      animation: pulseGlow 2s ease-in-out infinite;
    }

    @keyframes pulseGlow {
      0%, 100% {
        box-shadow: 0 0 10px rgba(255, 87, 34, 0.3);
      }
      50% {
        box-shadow: 0 0 20px rgba(255, 87, 34, 0.5);
      }
    }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ä»–äººã®ã‚¹ãƒˆãƒ¬ã‚¤ã‚¸é–¢é€£ã‚¹ã‚¿ã‚¤ãƒ« */
    @media (prefers-color-scheme: dark) {
      #viewOtherStorageSection {
        background: rgba(44, 62, 80, 0.5) !important;
      }

      #viewOtherStorageSection h3 {
        color: #ecf0f1 !important;
      }

      #viewOtherStorageSection p {
        color: #bdc3c7 !important;
      }

      #viewOtherStorageSection input {
        background: #2c3e50 !important;
        color: #ecf0f1 !important;
        border-color: #34495e !important;
      }

      #viewOtherStorageSection input:focus {
        border-color: #667eea !important;
      }

      #viewOtherStorageSection details > div {
        background: rgba(44, 62, 80, 0.8) !important;
        color: #bdc3c7 !important;
      }

      #viewingOtherStorageSection {
        background: rgba(255, 87, 34, 0.2) !important;
        border-color: #ff7043 !important;
      }
    }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
    @media (prefers-color-scheme: dark) {
      #imageDownloadModal > div > div {
        background: #34495e !important;
        color: #ecf0f1 !important;
        border: 1px solid #2c3e50 !important;
      }

      #imageDownloadModal h3 {
        color: #ecf0f1 !important;
      }

      #imageDownloadModal > div > div > div:nth-child(2) {
        background: #2c3e50 !important;
        border: 1px solid #34495e !important;
      }

      #imageDownloadModal > div > div > div:nth-child(3) {
        background: #f39c12 !important;
        border: 1px solid #e67e22 !important;
        color: #2c3e50 !important;
      }

      #imageDownloadModal #progressText {
        color: #bdc3c7 !important;
      }

      #imageDownloadModal #downloadProgress {
        background: #2c3e50 !important;
        border: 1px solid #34495e !important;
      }

      /* ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
      #driveExportModal > div > div {
        background: #34495e !important;
        color: #ecf0f1 !important;
        border: 1px solid #2c3e50 !important;
      }

      #driveExportModal h3 {
        color: #ecf0f1 !important;
      }

      #driveExportModal > div > div > div:nth-child(2) {
        background: #2c3e50 !important;
        border: 1px solid #34495e !important;
      }

      #driveExportModal ul {
        color: #bdc3c7 !important;
      }

      #driveExportModal p {
        color: #bdc3c7 !important;
      }

      #exportLoginPrompt {
        background: #f39c12 !important;
        border: 1px solid #e67e22 !important;
        color: #2c3e50 !important;
      }

      #exportExistsPrompt {
        background: #27ae60 !important;
        border: 1px solid #2ecc71 !important;
        color: #ecf0f1 !important;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ãƒ›ãƒ­ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ <br>ç®¡ç†ãƒ„ãƒ¼ãƒ«
  <span style="font-size: 0.4em; color: #999; display: block; margin-top: 5px; font-weight: normal;" id="versionDisplay">[v4.17.0]</span>
    </h1>

    <div class="menu-grid">
      <div class="menu-card" onclick="safeNavigate('card_list.html')" style="cursor: pointer;">
        <span class="menu-icon">ğŸƒ</span>
        <div class="menu-title">ã‚«ãƒ¼ãƒ‰ä¸€è¦§</div>
        <div class="menu-description">
          å…¨ã‚«ãƒ¼ãƒ‰ã®ä¸€è¦§è¡¨ç¤ºãƒ»æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ã€‚æ‰€æŒçŠ¶æ³ã®ç®¡ç†ã‚„CSVã§ã®ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãŒå¯èƒ½ã§ã™ã€‚
        </div>
      </div>

      <div class="menu-card" onclick="safeNavigate('binder_collection.html')" style="cursor: pointer;">
        <span class="menu-icon">ğŸ“š</span>
        <div class="menu-title">ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</div>
        <div class="menu-description">
          è¤‡æ•°ã®ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’ç®¡ç†ã€‚ãŠæ°—ã«å…¥ã‚Šã®è¡¨ç´™ç”»åƒã‚’è¨­å®šã—ã¦ã€ãƒ†ãƒ¼ãƒåˆ¥ã«ã‚«ãƒ¼ãƒ‰ã‚’ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ãã¾ã™ã€‚
        </div>
      </div>

      <div class="menu-card" onclick="safeNavigate('holoca_skill_page.html')" style="cursor: pointer;">
        <span class="menu-icon">ğŸ—‚ï¸</span>
        <div class="menu-title">ã‚«ãƒ¼ãƒ‰è©³ç´°æ¤œç´¢</div>
        <div class="menu-description">
          è©³ç´°ãªæ¡ä»¶ã§ã‚«ãƒ¼ãƒ‰ã‚’æ¤œç´¢ã€‚ã‚¹ã‚­ãƒ«ãƒ»èƒ½åŠ›ãƒ»ã‚³ã‚¹ãƒˆãªã©æ§˜ã€…ãªæ¡ä»¶ã§çµã‚Šè¾¼ã‚ã¾ã™ã€‚
        </div>
      </div>

      <div class="menu-card" onclick="safeNavigate('deck_builder.html')" style="cursor: pointer;">
        <span class="menu-icon">âš”ï¸</span>
        <div class="menu-title">ãƒ‡ãƒƒã‚­ä½œæˆ</div>
        <div class="menu-description">
          æˆ¦ç•¥çš„ãªãƒ‡ãƒƒã‚­ã‚’æ§‹ç¯‰ã€‚ã‚«ãƒ¼ãƒ‰ã®çµ„ã¿åˆã‚ã›ã‚’è€ƒãˆãªãŒã‚‰æœ€é©ãªãƒ‡ãƒƒã‚­ã‚’ä½œæˆã§ãã¾ã™ã€‚
        </div>
      </div>

      <div class="menu-card" onclick="safeNavigate('battle_simulator.html')" style="cursor: pointer;">
        <span class="menu-icon">ğŸ®</span>
        <div class="menu-title">ãƒãƒˆãƒ«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</div>
        <div class="menu-description">
          ä½œæˆã—ãŸãƒ‡ãƒƒã‚­ã§CPUã¨å¯¾æˆ¦ã€‚ãƒ›ãƒ­ãƒ©ã‚¤ãƒ–TCGã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ãŸæœ¬æ ¼çš„ãªãƒãƒˆãƒ«ãŒæ¥½ã—ã‚ã¾ã™ã€‚
        </div>
      </div>
    </div>

    <!-- èª­ã¿å–ã‚Šå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ -->
    <div id="readOnlyModeSection" style="text-align: center; margin: 20px 0; padding: 15px; background: rgba(0,0,0,0.05); border-radius: 10px;">
      <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
        <span id="readOnlyLabel" style="font-size: 14px; font-weight: bold; color: #666;">ğŸ”“ ç·¨é›†å¯èƒ½</span>
        <label class="toggle-switch" style="position: relative; display: inline-block; width: 56px; height: 28px;">
          <input type="checkbox" id="readOnlyToggle" onchange="toggleReadOnlyMode()" style="opacity: 0; width: 0; height: 0;">
          <span class="toggle-slider" style="
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 28px;
          "></span>
        </label>
        <span style="font-size: 12px; color: #888;">èª­ã¿å–ã‚Šå°‚ç”¨</span>
      </div>
      <p id="readOnlyDescription" style="margin: 10px 0 0 0; font-size: 12px; color: #888;">
        æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€ã‚«ãƒ¼ãƒ‰æ‰€æŒæ•°ãƒ»ãƒ‡ãƒƒã‚­ãƒ»ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã®ç·¨é›†ãŒã§ããªããªã‚Šã¾ã™
      </p>
    </div>

    <!-- ä»–äººã®ã‚¹ãƒˆãƒ¬ã‚¤ã‚¸é–²è¦§ä¸­ã®æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
    <div id="viewingOtherStorageSection" style="display: none; text-align: center; margin: 20px 0; padding: 15px; background: rgba(255, 87, 34, 0.1); border: 2px solid #ff5722; border-radius: 10px;">
      <div style="display: flex; align-items: center; justify-content: center; gap: 12px; flex-wrap: wrap;">
        <span style="font-size: 14px; font-weight: bold; color: #ff5722;">ğŸ‘ï¸ ä»–ã®äººã®ã‚¹ãƒˆãƒ¬ã‚¤ã‚¸ã‚’é–²è¦§ä¸­</span>
        <button onclick="stopViewingOtherStorage()" style="
          background: linear-gradient(45deg, #ff5722, #f44336);
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 20px;
          font-size: 13px;
          font-weight: bold;
          cursor: pointer;
          box-shadow: 0 4px 10px rgba(255, 87, 34, 0.3);
          transition: all 0.3s ease;
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 15px rgba(255, 87, 34, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 10px rgba(255, 87, 34, 0.3)';">
          âœ–ï¸ é–²è¦§ã‚’çµ‚äº†ã—ã¦è‡ªåˆ†ã®ã‚¹ãƒˆãƒ¬ã‚¤ã‚¸ã«æˆ»ã‚‹
        </button>
      </div>
      <p style="margin: 10px 0 0 0; font-size: 12px; color: #d84315;">
        é–²è¦§ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã«ã¯ä¸€åˆ‡å½±éŸ¿ã—ã¾ã›ã‚“ã€‚ãƒ‡ãƒ¼ã‚¿ã®ç·¨é›†ã¯ã§ãã¾ã›ã‚“ã€‚
      </p>
    </div>

    <!-- ä»–ã®äººã®ã‚¹ãƒˆãƒ¬ã‚¤ã‚¸ã‚’è¦‹ã‚‹ -->
    <div id="viewOtherStorageSection" style="text-align: center; margin: 20px 0; padding: 15px; background: rgba(0,0,0,0.05); border-radius: 10px;">
      <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #555;">ğŸ‘¥ ä»–ã®äººã®ã‚¹ãƒˆãƒ¬ã‚¤ã‚¸ã‚’è¦‹ã‚‹</h3>
      <p style="margin: 0 0 10px 0; font-size: 12px; color: #888;">
        å…±æœ‰ã•ã‚ŒãŸGoogleãƒ‰ãƒ©ã‚¤ãƒ–ã®ãƒ•ã‚¡ã‚¤ãƒ«IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„<br>
        <span style="color: #28a745; font-weight: bold;">âœ“ Googleãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ã§é–²è¦§ã§ãã¾ã™</span>
      </p>
      <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
        <input
          type="text"
          id="otherStorageFileId"
          placeholder="Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®ãƒ•ã‚¡ã‚¤ãƒ«IDï¼ˆä¾‹: 1a2b3c...ï¼‰"
          style="
            width: 100%;
            max-width: 500px;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
          "
          onfocus="this.style.borderColor='#667eea';"
          onblur="this.style.borderColor='#ddd';"
        />
        <button
          onclick="startViewingOtherStorage()"
          id="startViewingBtn"
          style="
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
          "
          onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)';"
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)';"
        >
          ğŸš€ é–‹å§‹
        </button>
      </div>
      <details style="margin-top: 15px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
        <summary style="cursor: pointer; font-size: 13px; color: #667eea; font-weight: bold;">ğŸ“– ãƒ•ã‚¡ã‚¤ãƒ«IDã®å–å¾—æ–¹æ³•</summary>
        <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 5px; font-size: 12px; line-height: 1.6;">
          <ol style="margin: 5px 0; padding-left: 20px;">
            <li>Googleãƒ‰ãƒ©ã‚¤ãƒ–ã§å…±æœ‰ã—ãŸã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆhololive_card_backup.jsonï¼‰ã‚’é–‹ã</li>
            <li>å³ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€Œå…±æœ‰ã€â†’ã€Œãƒªãƒ³ã‚¯ã‚’å–å¾—ã€ã‚’é¸æŠ</li>
            <li>ã€Œãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ã€ã«å¤‰æ›´ã—ã¦ã€Œãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã€</li>
            <li>ã‚³ãƒ”ãƒ¼ã—ãŸURLï¼ˆhttps://drive.google.com/file/d/<strong>ãƒ•ã‚¡ã‚¤ãƒ«ID</strong>/viewï¼‰ã‹ã‚‰<strong>ãƒ•ã‚¡ã‚¤ãƒ«ID</strong>éƒ¨åˆ†ã‚’æŠ½å‡º</li>
            <li>ä¸Šã®å…¥åŠ›æ¬„ã«ãƒ•ã‚¡ã‚¤ãƒ«IDã‚’è²¼ã‚Šä»˜ã‘ã¦ã€Œé–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
          </ol>
          <p style="margin: 10px 0 0 0; color: #d84315;">
            <strong>âš ï¸ æ³¨æ„:</strong> ãƒ•ã‚¡ã‚¤ãƒ«ã®å…±æœ‰è¨­å®šãŒã€Œãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ã€ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
          </p>
        </div>
      </details>
    </div>

    <!-- æ›´æ–°ç¢ºèªãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
    <div style="text-align: center; margin: 20px 0;">
      <button id="updateCheckBtn" onclick="checkForUpdates()" style="
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        transition: all 0.3s ease;
        margin: 0 10px;
      ">
        ğŸ”„ æ›´æ–°ç¢ºèª
      </button>
      <button id="driveExportBtn" onclick="showDriveExportDialog()" style="
        background: linear-gradient(45deg, #4285f4, #34a853);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
        transition: all 0.3s ease;
        margin: 0 10px;
      ">
        â˜ï¸ ãƒ‰ãƒ©ã‚¤ãƒ–ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
      </button>
      <!-- ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã®ã¿ç”»åƒä¸€æ‹¬DLãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º -->
      <button onclick="showImageDownloadDialog()" id="imageBulkDownloadBtn" class="mobile-only" style="
        background: linear-gradient(45deg, #007bff, #0056b3);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        transition: all 0.3s ease;
        margin: 0 10px;
      ">
        ğŸ“¥ ç”»åƒä¸€æ‹¬DL
      </button>
      <!-- ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã®ã¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º -->
      <button onclick="clearAllCache()" id="clearCacheBtn" class="mobile-only" style="
        background: linear-gradient(45deg, #dc3545, #c82333);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        transition: all 0.3s ease;
        margin: 0 10px;
      ">
        ğŸ—‘ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤
      </button>
      <div id="updateStatus" style="margin-top: 10px; font-size: 12px; color: #666; line-height: 1.3; max-width: 400px; white-space: pre-line;"></div>
    </div>

    <div class="footer">
      <p>Â© 2025 ikachan-desuyo - Hololive Card Game Management Tool</p>
      <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯éå…¬å¼ã®ãƒ•ã‚¡ãƒ³ãƒ¡ã‚¤ãƒ‰ãƒ„ãƒ¼ãƒ«ã§ã™</p>
      <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 0.85em; color: #888; line-height: 1.4;">
        <p><strong>æ¨©åˆ©è¡¨è¨˜ãƒ»å…è²¬äº‹é …</strong></p>
        <p>ã€Œãƒ›ãƒ­ãƒ©ã‚¤ãƒ–ã€ã€Œhololiveã€ã¯æ ªå¼ä¼šç¤¾ã‚«ãƒãƒ¼ã®å•†æ¨™ã§ã™ã€‚</p>
        <p>ã€Œãƒ›ãƒ­ãƒ©ã‚¤ãƒ–ã‚ªãƒ•ã‚£ã‚·ãƒ£ãƒ«ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ã€ã¯æ ªå¼ä¼šç¤¾ãƒ–ã‚·ãƒ­ãƒ¼ãƒ‰ã®å•†æ¨™ã§ã™ã€‚</p>
        <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯æ ªå¼ä¼šç¤¾ã‚«ãƒãƒ¼ãƒ»æ ªå¼ä¼šç¤¾ãƒ–ã‚·ãƒ­ãƒ¼ãƒ‰ã¨ã¯ç„¡é–¢ä¿‚ã®éå…¬å¼ãƒ•ã‚¡ãƒ³ãƒ¡ã‚¤ãƒ‰ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚</p>
        <p>ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®è‘—ä½œæ¨©ã¯å„æ¨©åˆ©è€…ã«å¸°å±ã—ã¾ã™ã€‚</p>
        <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã®ä½¿ç”¨ã«ã‚ˆã‚Šç”Ÿã˜ãŸæå®³ã«ã¤ã„ã¦ã€ä½œæˆè€…ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚</p>
      </div>
      <p id="offline-status" style="font-size: 0.8em; margin-top: 10px;"></p>
    </div>
  </div>

  <!-- ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="driveExportModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:2000; backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px);">
    <div style="display:flex; align-items:center; justify-content:center; width:100%; height:100%;">
      <div style="background:white; padding:30px; border-radius:10px; max-width:500px; width:90%; text-align:center; box-shadow:0 4px 20px rgba(0,0,0,0.3); animation: modalSlideIn 0.3s ease-out;">
        <h3 style="margin-top:0; color:#333;">â˜ï¸ Googleãƒ‰ãƒ©ã‚¤ãƒ–ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
        <div style="margin:20px 0; padding:15px; background:#f5f5f5; border-radius:5px; text-align:left;">
          <p style="margin:5px 0;"><strong>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå†…å®¹:</strong></p>
          <ul style="margin:10px 0; padding-left:20px; color:#666; font-size:0.95em;">
            <li>ã‚«ãƒ¼ãƒ‰æ‰€æŒæ•°</li>
            <li>ä¿å­˜ã—ãŸãƒ‡ãƒƒã‚­</li>
            <li>ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</li>
          </ul>
          <p style="margin:10px 0 5px 0; font-size:0.9em; color:#666;">
            <strong>ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> <span id="exportFileName">hololive_card_backup.json</span>
          </p>
        </div>
        <div id="exportLoginPrompt" style="display:none; margin:15px 0; padding:10px; background:#fff3cd; border:1px solid #ffeaa7; border-radius:5px; font-size:0.9em; color:#856404;">
          <strong>âš ï¸ Googleãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</strong><br>
          ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã«ã¯Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚
        </div>
        <div id="exportExistsPrompt" style="display:none; margin:15px 0; padding:10px; background:#d4edda; border:1px solid #c3e6cb; border-radius:5px; font-size:0.9em; color:#155724;">
          <strong>ğŸ“ æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</strong><br>
          <span id="existingFileInfo"></span><br>
          ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ
        </div>
        <div id="exportProgress" style="display:none; margin:15px 0;">
          <div style="background:#e9ecef; border-radius:10px; height:20px; overflow:hidden;">
            <div id="exportProgressBar" style="background:linear-gradient(90deg, #4285f4 0%, #34a853 100%); height:100%; width:0%; transition:width 0.3s;"></div>
          </div>
          <p id="exportProgressText" style="margin:10px 0; font-size:0.9em; color:#666;">æº–å‚™ä¸­...</p>
        </div>
        <div id="exportResult" style="display:none; margin:15px 0; padding:10px; border-radius:5px; font-size:0.9em;"></div>
        <div style="margin-top:20px;">
          <button onclick="executeExport(false)" id="exportStartBtn" style="background:#4285f4; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; margin-right:10px; font-size:16px; transition: all 0.3s ease;">â˜ï¸ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <button onclick="executeExport(true)" id="exportOverwriteBtn" style="display:none; background:#f4b400; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; margin-right:10px; font-size:16px; transition: all 0.3s ease;">ğŸ“ ä¸Šæ›¸ã</button>
          <button onclick="hideDriveExportDialog()" id="exportCancelBtn" style="background:#6c757d; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-size:16px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç”»åƒä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  <div id="imageDownloadModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:2000; backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px);">
    <div style="display:flex; align-items:center; justify-content:center; width:100%; height:100%;">
      <div style="background:white; padding:30px; border-radius:10px; max-width:500px; width:90%; text-align:center; box-shadow:0 4px 20px rgba(0,0,0,0.3); animation: modalSlideIn 0.3s ease-out;">
        <h3 style="margin-top:0; color:#333;">ğŸ“¥ ç”»åƒä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h3>
        <div style="margin:20px 0; padding:15px; background:#f5f5f5; border-radius:5px; text-align:left;">
          <p style="margin:5px 0;"><strong>å¯¾è±¡ç”»åƒæ•°:</strong> <span id="totalImageCount">-</span> æš</p>
          <p style="margin:5px 0;"><strong>æ¨å®šã‚µã‚¤ã‚º:</strong> <span id="estimatedSize">è¨ˆç®—ä¸­...</span></p>
          <p style="margin:5px 0;"><strong>ç¾åœ¨ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥:</strong> <span id="currentCacheInfo">ç¢ºèªä¸­...</span></p>
          <p style="margin:5px 0; font-size:0.9em; color:#666;">â€» 1æšã‚ãŸã‚Šç´„150-200KBã§è¨ˆç®—</p>
        </div>
        <div style="margin:15px 0; padding:10px; background:#fff3cd; border:1px solid #ffeaa7; border-radius:5px; font-size:0.9em; color:#856404;">
          <strong>âš ï¸ æ³¨æ„äº‹é …</strong><br>
          â€¢ ã‚«ãƒ¼ãƒ‰ä¸€è¦§ãƒšãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ©ç”¨ã—ã¦ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™<br>
          â€¢ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™<br>
          â€¢ ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿é€šä¿¡ã®å ´åˆã€é€šä¿¡é‡ã«ã”æ³¨æ„ãã ã•ã„<br>
          â€¢ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­ã¯ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„
        </div>
        <div id="downloadProgress" style="display:none; margin:15px 0;">
          <div style="background:#e9ecef; border-radius:10px; height:20px; overflow:hidden;">
            <div id="progressBar" style="background:linear-gradient(90deg, #007bff 0%, #28a745 100%); height:100%; width:0%; transition:width 0.3s;"></div>
          </div>
          <p id="progressText" style="margin:10px 0; font-size:0.9em; color:#666; white-space:pre-line;">æº–å‚™ä¸­...</p>
        </div>
        <div style="margin-top:20px;">
          <button onclick="startImageDownload()" id="startDownloadBtn" style="background:#007bff; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; margin-right:10px; font-size:16px; transition: all 0.3s ease;">ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹</button>
          <button onclick="clearImageCache()" id="clearCacheBtn" style="background:#dc3545; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; margin-right:10px; font-size:16px;">ğŸ—‘ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤</button>
          <button onclick="hideImageDownloadDialog()" id="cancelDownloadBtn" style="background:#6c757d; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-size:16px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // âœ… Service Worker ã¨ã®é€šä¿¡æ©Ÿèƒ½
    async function sendMessageToSW(type, data = null) {
      if (!navigator.serviceWorker.controller) return null;

      return new Promise((resolve) => {
        const messageChannel = new MessageChannel();
        messageChannel.port1.onmessage = (event) => {
          resolve(event.data);
        };

        navigator.serviceWorker.controller.postMessage(
          { type, data },
          [messageChannel.port2]
        );
      });
    }

    // âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
    async function getVersionInfo() {
      return await sendMessageToSW('GET_VERSION_INFO');
    }

    // âœ… æ›´æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
    async function getUpdateMessage() {
      return await sendMessageToSW('GET_UPDATE_MESSAGE');
    }

    // âœ… å¤ã„ãƒšãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯
    async function checkOutdatedPages() {
      return await sendMessageToSW('CHECK_OUTDATED_PAGES');
    }

    // Service Worker registration with centralized version management
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js', {
          updateViaCache: 'none' // ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã‚ãšå¸¸ã«æœ€æ–°ã‚’ãƒã‚§ãƒƒã‚¯
        })
          .then((registration) => {

            // ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ï¼šå³åº§ã«æ›´æ–°ãƒã‚§ãƒƒã‚¯
            registration.update();

            // âœ… æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã§æ›´æ–°ç¢ºèª
            const checkForUpdates = async () => {
              try {
                // Service Worker ãŒæº–å‚™ã§ãã‚‹ã¾ã§å¾…æ©Ÿ
                if (!navigator.serviceWorker.controller) {
                  setTimeout(checkForUpdates, 1000);
                  return;
                }

                const updateMessage = await getUpdateMessage();
                if (!updateMessage) return;

                if (confirm(updateMessage.data.message)) {
                  // å…¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å¾Œã«ãƒªãƒ­ãƒ¼ãƒ‰
                  const cacheNames = await caches.keys();
                  await Promise.all(cacheNames.map(cacheName => caches.delete(cacheName)));
                  window.location.href = window.location.href + '?v=' + Date.now();
                }
              } catch (error) {
              }
            };

            // Check for waiting service worker with new system
            if (registration.waiting) {
              setTimeout(checkForUpdates, 500);
            }

            // Listen for updates with new system
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              if (newWorker) {
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    setTimeout(checkForUpdates, 500);
                  }
                });
              }
            });

            // Listen for controller change
            navigator.serviceWorker.addEventListener('controllerchange', () => {
              window.location.reload();
            });
          })
          .catch((registrationError) => {
          });
      });
    }

    // ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ï¼šå®šæœŸçš„ãªæ›´æ–°ãƒã‚§ãƒƒã‚¯ï¼ˆ5åˆ†é–“éš”ï¼‰
    if ('serviceWorker' in navigator && /Mobi|Android/i.test(navigator.userAgent)) {
      setInterval(async () => {
        try {
          const registration = await navigator.serviceWorker.getRegistration();
          if (registration) {
            await registration.update();
          }
        } catch (error) {
        }
      }, 5 * 60 * 1000); // 5åˆ†é–“éš”
    }

    // Online/Offline status
    function updateOnlineStatus() {
      const statusElement = document.getElementById('offline-status');
      if (navigator.onLine) {
        statusElement.textContent = 'ğŸŸ¢ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ - æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­';
        statusElement.style.color = '#4CAF50';
      } else {
        statusElement.textContent = 'ğŸ”´ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ä¸­';
        statusElement.style.color = '#F44336';
      }
    }

    // Update status on page load and network changes
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    window.addEventListener('load', updateOnlineStatus);

    // Manual update check function
    let serviceWorkerRegistration = null;

    // Store registration for manual update checks
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then((registration) => {
            serviceWorkerRegistration = registration;
            // ... existing code above
          });
      });
    }

    async function checkForUpdates() {
      const statusEl = document.getElementById('updateStatus');
      const btnEl = document.getElementById('updateCheckBtn');

      if (!navigator.onLine) {
        statusEl.textContent = 'âš ï¸ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã§ã¯æ›´æ–°ç¢ºèªã§ãã¾ã›ã‚“';
        statusEl.style.color = '#ff9800';
        return;
      }

      try {
        btnEl.disabled = true;
        btnEl.textContent = 'ğŸ”„ ç¢ºèªä¸­...';
        statusEl.textContent = 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’ç¢ºèªä¸­...';
        statusEl.style.color = '#2196f3';

        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
          const messageChannel = new MessageChannel();

          // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ10ç§’ï¼‰
          const timeout = new Promise((_, reject) =>
            setTimeout(() => reject(new Error('Service Worker timeout')), 10000)
          );

          // Service Workerã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å¾…æ©Ÿ
          const checkPromise = new Promise((resolve, reject) => {
            messageChannel.port1.onmessage = (event) => {
              if (event.data.type === 'VERSION_MISMATCH_RESPONSE') {
                resolve(event.data.data);
              } else if (event.data.type === 'VERSION_MISMATCH_ERROR') {
                reject(new Error(event.data.error));
              }
            };
          });

          // è©³ç´°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯è¦æ±‚ã‚’é€ä¿¡
          navigator.serviceWorker.controller.postMessage(
            { type: 'CHECK_VERSION_MISMATCH' },
            [messageChannel.port2]
          );

          // ãƒ¬ã‚¹ãƒãƒ³ã‚¹å¾…æ©Ÿï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãï¼‰
          const versionCheckResult = await Promise.race([checkPromise, timeout]);

          if (versionCheckResult.hasUpdates) {
            // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸ä¸€è‡´ã®è©³ç´°æƒ…å ±ã‚’ç”Ÿæˆ
            let detailMessage = 'ğŸš€ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ä¸ä¸€è‡´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:\n\n';
            detailMessage += `ğŸ“Š ã‚¢ãƒ—ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³: v${versionCheckResult.currentAppVersion}\n`;
            detailMessage += `ğŸ• ãƒã‚§ãƒƒã‚¯æ™‚åˆ»: ${new Date(versionCheckResult.timestamp).toLocaleString('ja-JP')}\n\n`;

            versionCheckResult.outdatedPages.forEach(pageInfo => {
              detailMessage += `ğŸ“„ ${pageInfo.page}:\n`;
              detailMessage += `  â”£ æœŸå¾…ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v${pageInfo.expectedVersion}\n`;
              detailMessage += `  â”£ å®Ÿéš›ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v${pageInfo.actualVersion || 'ä¸æ˜'}\n`;
              detailMessage += `  â”£ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v${pageInfo.cachedVersion || 'ãªã—'}\n`;

              // ãƒŸã‚¹ãƒãƒƒãƒã®ç†ç”±ã‚’æ—¥æœ¬èªã§èª¬æ˜
              let reasonText = '';
              switch(pageInfo.reason) {
                case 'expected_vs_actual_mismatch':
                  reasonText = 'æœŸå¾…ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨å®Ÿéš›ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸ä¸€è‡´';
                  break;
                case 'actual_vs_cached_mismatch':
                  reasonText = 'å®Ÿéš›ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸ä¸€è‡´';
                  break;
                case 'actual_version_not_found':
                  reasonText = 'å®Ÿéš›ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                  break;
                case 'no_cached_version':
                  reasonText = 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“';
                  break;
                default:
                  reasonText = pageInfo.reason;
              }
              detailMessage += `  â”— ç†ç”±: ${reasonText}\n\n`;
            });

            statusEl.innerHTML = `ğŸš€ æ›´æ–°ãŒåˆ©ç”¨å¯èƒ½ã§ã™ (${versionCheckResult.outdatedPages.length}ãƒšãƒ¼ã‚¸)<br><small>è©³ç´°æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„</small>`;
            statusEl.style.color = '#4caf50';

            setTimeout(() => {
              if (confirm(detailMessage + 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸ä¸€è‡´ã®ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã‹ï¼Ÿ')) {
                statusEl.innerHTML = `âš¡ æ›´æ–°ä¸­...<br><small>å¯¾è±¡ãƒšãƒ¼ã‚¸ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ä¸­</small>`;
                statusEl.style.color = '#ff9800';

                // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸ä¸€è‡´ã®ãƒšãƒ¼ã‚¸ã®ã¿ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã—ãŸæ›´æ–°å‡¦ç†

                // Service Workerã«å¼·åˆ¶æ›´æ–°ã‚’è¦æ±‚ï¼ˆå¯¾è±¡ãƒšãƒ¼ã‚¸ã®ã¿ï¼‰
                if (navigator.serviceWorker.controller) {
                  navigator.serviceWorker.controller.postMessage({
                    type: 'FORCE_UPDATE',
                    outdatedPages: versionCheckResult.outdatedPages.map(p => p.page)
                  });
                }

                // å¯¾è±¡ãƒšãƒ¼ã‚¸ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ + å¿…è¦æœ€å°é™ã®å…¨ä½“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
                if ('caches' in window) {
                  caches.keys().then(cacheNames => {
                    return Promise.all(cacheNames.map(cacheName => {
                      return caches.delete(cacheName);
                    }));
                  }).then(() => {
                    statusEl.innerHTML = `ğŸ”„ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†èª­ã¿è¾¼ã¿ä¸­...<br><small>æ›´æ–°ã•ã‚ŒãŸãƒšãƒ¼ã‚¸ã‚’åæ˜ ã—ã¾ã™</small>`;
                    // Service Workerã®æ›´æ–°ã‚’å¾…ã¤
                    return new Promise(resolve => setTimeout(resolve, 1000));
                  }).then(() => {
                    // å¯¾è±¡ãƒšãƒ¼ã‚¸ã®æ›´æ–°ã‚’åæ˜ ã™ã‚‹ãŸã‚ã®ãƒªãƒ­ãƒ¼ãƒ‰
                    if (window.location.reload) {
                      window.location.reload(true); // å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰
                    } else {
                      window.location.href = window.location.href + '?t=' + Date.now();
                    }
                  }).catch(error => {
                    window.location.href = window.location.href + '?t=' + Date.now();
                  });
                } else {
                  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥APIãŒä½¿ãˆãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                  window.location.href = window.location.href + '?t=' + Date.now();
                }
              } else {
                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã¯å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
                statusEl.innerHTML = `â„¹ï¸ æ›´æ–°ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ<br><small>å¿…è¦ãªæ™‚ã«å†åº¦ç¢ºèªã—ã¦ãã ã•ã„</small>`;
                statusEl.style.color = '#2196f3';
              }
            }, 2000);
          } else {
            // æœ€æ–°ã®å ´åˆã€æ¯”è¼ƒã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’è©³ç´°è¡¨ç¤º
            let versionDetails = `âœ… æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ v${versionCheckResult.currentAppVersion}<br>`;
            versionDetails += `<small>ğŸ“Š å„ãƒšãƒ¼ã‚¸ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±:<br><br>`;

            if (versionCheckResult.allPages && versionCheckResult.allPages.length > 0) {
              versionCheckResult.allPages.forEach(pageInfo => {
                const pageName = pageInfo.page.replace('.html', '');
                const expectedV = pageInfo.expectedVersion;
                const actualV = pageInfo.actualVersion;
                const status = expectedV === actualV ? 'âœ…' : 'âš ï¸';

                versionDetails += `${status} ${pageName}<br>`;
                versionDetails += `&nbsp;&nbsp;â”œ æœ€æ–°: v${expectedV}<br>`;
                versionDetails += `&nbsp;&nbsp;â”” ç¾åœ¨: v${actualV}<br><br>`;
              });
            } else {
              versionDetails += `å…¨ãƒšãƒ¼ã‚¸ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒæœ€æ–°ã§ã™`;
            }
            versionDetails += `</small>`;

            statusEl.innerHTML = versionDetails;
            statusEl.style.color = '#4caf50';
            setTimeout(() => {
              statusEl.textContent = '';
            }, 7000); // è¡¨ç¤ºæ™‚é–“ã‚’å»¶é•·
          }
        } else {
          statusEl.textContent = 'âš ï¸ Service Worker ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“';
          statusEl.style.color = '#ff9800';
        }

      } catch (error) {
        statusEl.textContent = 'âŒ æ›´æ–°ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
        statusEl.style.color = '#f44336';
      } finally {
        btnEl.disabled = false;
        btnEl.textContent = 'ğŸ”„ æ›´æ–°ç¢ºèª';
      }
    }

    // ã‚»ãƒ¼ãƒ•ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãï¼‰
    function safeNavigate(url) {
      
      // offline-utils.js ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      if (typeof window.navigateToPage === 'function') {
        window.navigateToPage(url);
      } else {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: é€šå¸¸ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
        if (navigator.onLine) {
          window.location.href = url;
        } else {
          // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
          if (confirm('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã§ã™ã€‚ã“ã®ãƒšãƒ¼ã‚¸ãŒåˆ©ç”¨ã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\nç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ')) {
            window.location.href = url;
          }
        }
      }
    }

    // ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
    async function showImageDownloadDialog() {
      
      // ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã®ã¿è¡¨ç¤ºï¼ˆã‚ˆã‚Šå³å¯†ãªåˆ¤å®šï¼‰
      const isMobile = window.innerWidth <= 768 || /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      if (!isMobile) {
        alert('ç”»åƒä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¯ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã§ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚');
        return;
      }
      
      if (imageDownloadInProgress) {
        alert('ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Ÿè¡Œä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
        return;
      }

      
      // ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      if (cards.length === 0) {
        const loadedCards = await loadCardData();
        if (loadedCards.length === 0) {
          return; // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—
        }
      }

      const modal = document.getElementById('imageDownloadModal');
      const totalImageCountEl = document.getElementById('totalImageCount');
      const estimatedSizeEl = document.getElementById('estimatedSize');
      const currentCacheInfoEl = document.getElementById('currentCacheInfo');
      const startBtn = document.getElementById('startDownloadBtn');
      
      // ç”»åƒæ•°ã‚’è¨ˆç®—
      const imageUrls = extractImageUrls();
      const totalCount = imageUrls.length;
      
      
      if (totalCount === 0) {
        alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯¾è±¡ã®ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      
      // æ¨å®šã‚µã‚¤ã‚ºã‚’è¨ˆç®—ï¼ˆ1æšã‚ãŸã‚Š150-200KBã§è¨ˆç®—ï¼‰
      const avgSizeKB = 175; // å¹³å‡ã‚µã‚¤ã‚º
      const estimatedSizeMB = Math.round((totalCount * avgSizeKB) / 1024 * 10) / 10;
      
      totalImageCountEl.textContent = totalCount.toLocaleString();
      estimatedSizeEl.textContent = `ç´„ ${estimatedSizeMB.toLocaleString()} MB`;
      
      // è©³ç´°ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥çŠ¶æ³ã‚’éåŒæœŸã§å–å¾—
      currentCacheInfoEl.textContent = 'ç¢ºèªä¸­...';
      startBtn.disabled = true;
      startBtn.textContent = 'ç¢ºèªä¸­...';
      
      checkCacheStatus().then(cacheStatus => {
        if (cacheStatus.cached === cacheStatus.total && cacheStatus.total > 0) {
          // å…¨ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿
          currentCacheInfoEl.innerHTML = `âœ… <strong>å…¨ç”»åƒã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿</strong> (${cacheStatus.cached}/${cacheStatus.total}æš)`;
          startBtn.disabled = true;
          startBtn.textContent = 'ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿';
          startBtn.style.background = '#28a745';
        } else if (cacheStatus.cached > 0) {
          // ä¸€éƒ¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿
          currentCacheInfoEl.innerHTML = `âš ï¸ <strong>ä¸€éƒ¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿</strong> (${cacheStatus.cached}/${cacheStatus.total}æš)<br>æœªã‚­ãƒ£ãƒƒã‚·ãƒ¥: ${cacheStatus.uncached}æš`;
          startBtn.disabled = false;
          startBtn.textContent = `ğŸ“¥ æ®‹ã‚Š${cacheStatus.uncached}æšã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰`;
          startBtn.style.background = '#ffc107';
          startBtn.style.color = '#212529';
        } else {
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—
          currentCacheInfoEl.innerHTML = `âŒ <strong>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—</strong> (0/${cacheStatus.total}æš)`;
          startBtn.disabled = false;
          startBtn.textContent = 'ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹';
          startBtn.style.background = '#007bff';
          startBtn.style.color = 'white';
        }
        
        // æ¨å®šãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚µã‚¤ã‚ºã‚’æœªã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ†ã®ã¿ã§å†è¨ˆç®—
        if (cacheStatus.uncached > 0) {
          const uncachedSizeMB = Math.round((cacheStatus.uncached * avgSizeKB) / 1024 * 10) / 10;
          estimatedSizeEl.textContent = `ç´„ ${uncachedSizeMB.toLocaleString()} MB (æœªã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ†)`;
        } else if (cacheStatus.cached > 0) {
          estimatedSizeEl.textContent = `ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸è¦`;
        }
        
      }).catch(error => {
        currentCacheInfoEl.textContent = 'âŒ æƒ…å ±å–å¾—å¤±æ•—';
        startBtn.disabled = false;
        startBtn.textContent = 'ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹';
      });
      
      modal.style.display = 'block';
    }

    // ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’éè¡¨ç¤º
    function hideImageDownloadDialog() {
      const modal = document.getElementById('imageDownloadModal');
      
      if (imageDownloadInProgress) {
        const confirmClose = confirm('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Ÿè¡Œä¸­ã§ã™ã€‚ä¸­æ–­ã—ã¾ã™ã‹ï¼Ÿ');
        if (!confirmClose) return;
        
        // ä¸­æ–­ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
        imageDownloadInProgress = false;
      }
      
      modal.style.display = 'none';
      
      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
      resetDownloadProgress();
    }

    // ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç”»åƒURLã‚’æŠ½å‡º
    function extractImageUrls() {
      const imageUrls = [];
      const seenUrls = new Set();
      
      
      // ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã®å ´åˆã€å€¤ã‚’å–å¾—
      const cardArray = Array.isArray(cards) ? cards : Object.values(cards);
      
      for (const card of cardArray) {
        // image_url ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰ç”»åƒURLã‚’å–å¾—ï¼ˆãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«åˆã‚ã›ã¦ä¿®æ­£ï¼‰
        const imageUrl = card.image_url || card.image;
        if (imageUrl && !seenUrls.has(imageUrl)) {
          imageUrls.push(imageUrl);
          seenUrls.add(imageUrl);
        }
      }
      
      return imageUrls;
    }

    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆ
    function resetDownloadProgress() {
      const progressDiv = document.getElementById('downloadProgress');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const startBtn = document.getElementById('startDownloadBtn');
      const cancelBtn = document.getElementById('cancelDownloadBtn');
      
      progressDiv.style.display = 'none';
      progressBar.style.width = '0%';
      progressText.textContent = 'æº–å‚™ä¸­...';
      startBtn.disabled = false;
      startBtn.textContent = 'ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹';
      cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
    }

    // ç”»åƒä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹ï¼ˆcard_list.jsã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç§»æ¤ï¼‰
    async function startImageDownload() {
      if (imageDownloadInProgress) return;
      
      imageDownloadInProgress = true;
      
      const progressDiv = document.getElementById('downloadProgress');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const startBtn = document.getElementById('startDownloadBtn');
      const cancelBtn = document.getElementById('cancelDownloadBtn');
      
      // UIã‚’æ›´æ–°
      progressDiv.style.display = 'block';
      startBtn.disabled = true;
      startBtn.textContent = 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...';
      cancelBtn.textContent = 'ä¸­æ–­';
      
      try {
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€æœªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ç”»åƒã®ã¿ã‚’å¯¾è±¡ã«ã™ã‚‹
        progressText.textContent = 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥çŠ¶æ³ã‚’ç¢ºèªä¸­...';
        const cacheStatus = await checkCacheStatus();
        
        if (cacheStatus.uncached === 0) {
          // å…¨ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿
          progressText.textContent = 'âœ… å…¨ã¦ã®ç”»åƒã¯æ—¢ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã„ã¾ã™';
          startBtn.textContent = 'âœ… å®Œäº†';
          cancelBtn.textContent = 'é–‰ã˜ã‚‹';
          alert('å…¨ã¦ã®ç”»åƒã¯æ—¢ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã®å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
          return;
        }
        
        const imageUrls = cacheStatus.uncachedUrls; // æœªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ç”»åƒã®ã¿
        const totalCount = imageUrls.length;
        let successCount = 0;
        let failureCount = 0;
        
        
        progressText.textContent = `æœªã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”»åƒã‚’äº‹å‰èª­ã¿è¾¼ã¿ä¸­... (${totalCount}æš)`;
        
        // ãƒãƒƒãƒã‚µã‚¤ã‚ºï¼ˆåŒæ™‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ•°ï¼‰
        const batchSize = 3; // ãƒãƒƒãƒã‚µã‚¤ã‚ºã‚’å°ã•ãã—ã¦å®‰å®šæ€§å‘ä¸Š
        
        for (let i = 0; i < imageUrls.length; i += batchSize) {
          if (!imageDownloadInProgress) {
            break; // ä¸­æ–­ã•ã‚ŒãŸå ´åˆ
          }
          
          const batch = imageUrls.slice(i, i + batchSize);
          
          const batchPromises = batch.map(async (url) => {
            return new Promise(async (resolve) => {
              try {
                const timeout = setTimeout(() => {
                  resolve({ success: false, url, error: 'Timeout' });
                }, 15000); // 15ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                
                // Service WorkerãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ã™ã‚‹ã‚ˆã†ã«fetchã‚’å®Ÿè¡Œ
                const response = await fetch(url);
                
                clearTimeout(timeout);
                
                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
                if (response.ok || response.type === 'opaque') {
                  resolve({ success: true, url, cached: true });
                } else {
                  resolve({ success: false, url, error: `HTTP ${response.status}` });
                }
                
              } catch (error) {
                
                // fetchå¤±æ•—ã®å ´åˆã€Imageã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                try {
                  const img = new Image();
                  const imgTimeout = setTimeout(() => {
                    resolve({ success: false, url, error: 'Image load timeout' });
                  }, 10000);
                  
                  img.onload = () => {
                    clearTimeout(imgTimeout);
                    resolve({ success: true, url, cached: false });
                  };
                  
                  img.onerror = () => {
                    clearTimeout(imgTimeout);
                    resolve({ success: false, url, error: 'Image load failed' });
                  };
                  
                  img.src = url;
                } catch (imgError) {
                  resolve({ success: false, url, error: `Both fetch and image failed: ${error.message}` });
                }
              }
            });
          });
          
          // ãƒãƒƒãƒå®Ÿè¡Œ
          const batchResults = await Promise.all(batchPromises);
          
          // çµæœã‚’é›†è¨ˆ
          batchResults.forEach(result => {
            if (result.success) {
              successCount++;
            } else {
              failureCount++;
            }
          });
          
          // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
          const progress = Math.round((successCount + failureCount) / totalCount * 100);
          progressBar.style.width = `${progress}%`;
          
          // å…¨ä½“ã®é€²æ—æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆæ—¢ã‚­ãƒ£ãƒƒã‚·ãƒ¥ + æ–°è¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
          const totalCachedNow = cacheStatus.cached + successCount;
          const grandTotal = cacheStatus.total;
          progressText.textContent = `${successCount + failureCount} / ${totalCount} å®Œäº† (æˆåŠŸ: ${successCount}, å¤±æ•—: ${failureCount})\nå…¨ä½“: ${totalCachedNow}/${grandTotal}æšãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿`;
          
          // å°‘ã—å¾…æ©Ÿï¼ˆã‚µãƒ¼ãƒãƒ¼è² è·è»½æ¸›ï¼‰
          await new Promise(resolve => setTimeout(resolve, 300));
        }
        
        if (imageDownloadInProgress) {
          // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          const totalCachedFinal = cacheStatus.cached + successCount;
          const grandTotal = cacheStatus.total;
          
          if (failureCount === 0) {
            progressText.textContent = `âœ… æ–°è¦ç”»åƒã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼ (${successCount}æš)\nå…¨ä½“: ${totalCachedFinal}/${grandTotal}æšãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿`;
            alert(`ç”»åƒä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\næ–°è¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰: ${successCount}æš\næ—¢å­˜ã‚­ãƒ£ãƒƒã‚·ãƒ¥: ${cacheStatus.cached}æš\nåˆè¨ˆ: ${totalCachedFinal}/${grandTotal}æš\n\nã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚ç”»åƒãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚`);
          } else {
            progressText.textContent = `âš ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº† (æˆåŠŸ: ${successCount}æš, å¤±æ•—: ${failureCount}æš)\nå…¨ä½“: ${totalCachedFinal}/${grandTotal}æšãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿`;
            alert(`ç”»åƒä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n\næ–°è¦æˆåŠŸ: ${successCount}æš\nå¤±æ•—: ${failureCount}æš\næ—¢å­˜ã‚­ãƒ£ãƒƒã‚·ãƒ¥: ${cacheStatus.cached}æš\n\næˆåŠŸã—ãŸç”»åƒã¯ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚`);
          }
          
          startBtn.textContent = 'âœ… å®Œäº†';
          cancelBtn.textContent = 'é–‰ã˜ã‚‹';
        } else {
          // ä¸­æ–­ã•ã‚ŒãŸå ´åˆ
          const totalCachedFinal = cacheStatus.cached + successCount;
          const grandTotal = cacheStatus.total;
          progressText.textContent = `âŒ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸ (æˆåŠŸ: ${successCount}æš, å¤±æ•—: ${failureCount}æš)\nå…¨ä½“: ${totalCachedFinal}/${grandTotal}æšãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿`;
          startBtn.textContent = 'ä¸­æ–­æ¸ˆã¿';
          cancelBtn.textContent = 'é–‰ã˜ã‚‹';
        }
        
      } catch (error) {
        progressText.textContent = 'âŒ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        alert(`ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š${error.message}`);
        
        startBtn.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼';
        cancelBtn.textContent = 'é–‰ã˜ã‚‹';
      } finally {
        imageDownloadInProgress = false;
        startBtn.disabled = false;
      }
    }

    // ç”»åƒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
    async function clearImageCache() {
      if (!confirm('ç”»åƒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nå‰Šé™¤å¾Œã¯å†åº¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚')) {
        return;
      }

      const clearBtn = document.getElementById('clearCacheBtn');
      const originalText = clearBtn.textContent;
      
      try {
        clearBtn.disabled = true;
        clearBtn.textContent = 'å‰Šé™¤ä¸­...';
        
        // ã™ã¹ã¦ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å–å¾—
        const cacheNames = await caches.keys();
        
        let deletedCount = 0;
        let totalSize = 0;
        
        // ç”»åƒé–¢é€£ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤
        for (const cacheName of cacheNames) {
          const cache = await caches.open(cacheName);
          const requests = await cache.keys();
          
          for (const request of requests) {
            // ç”»åƒURLã¾ãŸã¯hololive-official-cardgame.comã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‰Šé™¤
            if (request.url.includes('hololive-official-cardgame.com') ||
                request.url.includes('.jpg') ||
                request.url.includes('.png') ||
                request.url.includes('.jpeg') ||
                request.url.includes('.webp')) {
              
              const response = await cache.match(request);
              if (response) {
                const clonedResponse = response.clone();
                try {
                  // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚µã‚¤ã‚ºã‚’æ¨å®šï¼ˆå¯èƒ½ã§ã‚ã‚Œã°ï¼‰
                  const blob = await clonedResponse.blob();
                  totalSize += blob.size;
                } catch (e) {
                  // ã‚µã‚¤ã‚ºå–å¾—å¤±æ•—ã¯ç„¡è¦–
                }
              }
              
              await cache.delete(request);
              deletedCount++;
            }
          }
        }
        
        // ã‚µã‚¤ã‚ºã‚’äººé–“ãŒèª­ã‚ã‚‹å½¢å¼ã«å¤‰æ›
        const sizeText = totalSize > 0 ? 
          `ç´„ ${(totalSize / (1024 * 1024)).toFixed(1)} MB` : 
          'ä¸æ˜';
        
        clearBtn.textContent = 'âœ… å‰Šé™¤å®Œäº†';
        
        alert(`ç”»åƒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼\n\nå‰Šé™¤ã—ãŸç”»åƒæ•°: ${deletedCount}æš\nå‰Šé™¤ã—ãŸã‚µã‚¤ã‚º: ${sizeText}\n\næ¬¡å›è¡¨ç¤ºæ™‚ã«ã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰ç”»åƒã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚`);
        
        // UIã‚’ãƒªã‚»ãƒƒãƒˆ
        setTimeout(() => {
          clearBtn.textContent = originalText;
          clearBtn.disabled = false;
        }, 2000);
        
      } catch (error) {
        clearBtn.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼';
        alert(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š${error.message}`);
        
        setTimeout(() => {
          clearBtn.textContent = originalText;
          clearBtn.disabled = false;
        }, 2000);
      }
    }

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥çŠ¶æ³ã‚’è©³ç´°ãƒã‚§ãƒƒã‚¯
    async function checkCacheStatus() {
      try {
        const imageUrls = extractImageUrls();
        const cacheNames = await caches.keys();
        
        let cachedUrls = new Set();
        let uncachedUrls = [];
        
        // ã™ã¹ã¦ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ãƒã‚§ãƒƒã‚¯
        for (const cacheName of cacheNames) {
          const cache = await caches.open(cacheName);
          
          for (const url of imageUrls) {
            const response = await cache.match(url);
            if (response) {
              cachedUrls.add(url);
            }
          }
        }
        
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã„ãªã„URLã‚’ç‰¹å®š
        for (const url of imageUrls) {
          if (!cachedUrls.has(url)) {
            uncachedUrls.push(url);
          }
        }
        
        return {
          total: imageUrls.length,
          cached: cachedUrls.size,
          uncached: uncachedUrls.length,
          cachedUrls: Array.from(cachedUrls),
          uncachedUrls: uncachedUrls
        };
        
      } catch (error) {
        return {
          total: 0,
          cached: 0,
          uncached: 0,
          cachedUrls: [],
          uncachedUrls: []
        };
      }
    }

    // ç”»åƒä¸€æ‹¬DLæ©Ÿèƒ½ - ã‚«ãƒ¼ãƒ‰ä¸€è¦§ãƒšãƒ¼ã‚¸ã¨é€£æº
    let imageDownloadInProgress = false;
    let cards = []; // ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿æŒ

    // ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿
    async function loadCardData() {
      try {
        const response = await fetch('json_file/card_data.json');
        if (!response.ok) throw new Error('ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        const cardData = await response.json();
        
        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯é…åˆ—ã«å¤‰æ›
        cards = Array.isArray(cardData) ? cardData : Object.values(cardData);
        return cards;
      } catch (error) {
        alert('ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        return [];
      }
    }

    // èª­ã¿å–ã‚Šå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
    function toggleReadOnlyMode() {
      const toggle = document.getElementById('readOnlyToggle');
      const isEnabled = toggle.checked;

      // utils.js ã® readOnlyMode ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨
      if (window.readOnlyMode) {
        window.readOnlyMode.setEnabled(isEnabled);
      } else {
        localStorage.setItem('readOnlyMode', isEnabled ? 'true' : 'false');
      }

      updateReadOnlyUI(isEnabled);
    }

    // èª­ã¿å–ã‚Šå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã®UIæ›´æ–°
    function updateReadOnlyUI(isEnabled) {
      const label = document.getElementById('readOnlyLabel');
      const description = document.getElementById('readOnlyDescription');

      if (isEnabled) {
        label.textContent = 'ğŸ”’ èª­ã¿å–ã‚Šå°‚ç”¨';
        label.style.color = '#dc3545';
        description.textContent = 'ã‚«ãƒ¼ãƒ‰æ‰€æŒæ•°ãƒ»ãƒ‡ãƒƒã‚­ãƒ»ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã®ç·¨é›†ãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã¾ã™';
        description.style.color = '#dc3545';
      } else {
        label.textContent = 'ğŸ”“ ç·¨é›†å¯èƒ½';
        label.style.color = '#28a745';
        description.textContent = 'æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€ã‚«ãƒ¼ãƒ‰æ‰€æŒæ•°ãƒ»ãƒ‡ãƒƒã‚­ãƒ»ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã®ç·¨é›†ãŒã§ããªããªã‚Šã¾ã™';
        description.style.color = '#888';
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«èª­ã¿å–ã‚Šå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
    function initializeReadOnlyMode() {
      const isEnabled = localStorage.getItem('readOnlyMode') === 'true';
      const toggle = document.getElementById('readOnlyToggle');

      if (toggle) {
        toggle.checked = isEnabled;
        updateReadOnlyUI(isEnabled);
      }
    }

    // DOMContentLoaded ã§åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      initializeReadOnlyMode();
      initializeViewingOtherStorageUI();
    });

    // ===== ä»–äººã®ã‚¹ãƒˆãƒ¬ã‚¤ã‚¸é–²è¦§æ©Ÿèƒ½ =====

    /**
     * ä»–äººã®ã‚¹ãƒˆãƒ¬ã‚¤ã‚¸é–²è¦§UIã®åˆæœŸåŒ–
     */
    function initializeViewingOtherStorageUI() {
      // é–²è¦§ä¸­ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
      if (window.storageProvider && window.storageProvider.isViewing()) {
        updateViewingUI(true);
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
      window.addEventListener('storageProviderChange', function(e) {
        updateViewingUI(e.detail.isViewing);
      });
    }

    /**
     * ä»–äººã®ã‚¹ãƒˆãƒ¬ã‚¤ã‚¸ã®é–²è¦§ã‚’é–‹å§‹
     * Googleã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªãã¦ã‚‚å…¬é–‹ãƒ•ã‚¡ã‚¤ãƒ«ãªã‚‰é–²è¦§å¯èƒ½
     */
    async function startViewingOtherStorage() {
      const fileIdInput = document.getElementById('otherStorageFileId');
      const startBtn = document.getElementById('startViewingBtn');

      if (!fileIdInput || !startBtn) return;

      const fileId = fileIdInput.value.trim();

      if (!fileId) {
        alert('ãƒ•ã‚¡ã‚¤ãƒ«IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        fileIdInput.focus();
        return;
      }

      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      startBtn.disabled = true;
      startBtn.textContent = 'ğŸ“¥ èª­ã¿è¾¼ã¿ä¸­...';

      try {
        // Googleãƒ‰ãƒ©ã‚¤ãƒ–ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ï¼‰
        const result = await window.googleDriveSync.loadFromOtherStorage(fileId);

        if (!result.success) {
          alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
          startBtn.disabled = false;
          startBtn.textContent = 'ğŸš€ é–‹å§‹';
          return;
        }

        // é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹
        if (window.storageProvider.startViewing(result.data)) {
          window.showToast('ä»–ã®äººã®ã‚¹ãƒˆãƒ¬ã‚¤ã‚¸ã®é–²è¦§ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success');

          // UIã‚’æ›´æ–°
          updateViewingUI(true);

          // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
          fileIdInput.value = '';
        } else {
          alert('é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

      } catch (error) {
        console.error('é–²è¦§é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
        alert('äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
      } finally {
        startBtn.disabled = false;
        startBtn.textContent = 'ğŸš€ é–‹å§‹';
      }
    }

    /**
     * ä»–äººã®ã‚¹ãƒˆãƒ¬ã‚¤ã‚¸ã®é–²è¦§ã‚’çµ‚äº†
     */
    function stopViewingOtherStorage() {
      if (confirm('é–²è¦§ã‚’çµ‚äº†ã—ã¦è‡ªåˆ†ã®ã‚¹ãƒˆãƒ¬ã‚¤ã‚¸ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ\n\nãƒšãƒ¼ã‚¸ãŒãƒªãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚')) {
        if (window.storageProvider) {
          window.storageProvider.stopViewing();
        }
      }
    }

    /**
     * é–²è¦§UIã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
     * @param {boolean} isViewing - é–²è¦§ä¸­ã‹ã©ã†ã‹
     */
    function updateViewingUI(isViewing) {
      const readOnlyModeSection = document.getElementById('readOnlyModeSection');
      const viewingSection = document.getElementById('viewingOtherStorageSection');
      const viewOtherSection = document.getElementById('viewOtherStorageSection');

      if (isViewing) {
        // é–²è¦§ä¸­: èª­ã¿å–ã‚Šå°‚ç”¨ãƒˆã‚°ãƒ«ã‚’éè¡¨ç¤ºã€é–²è¦§ä¸­ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã€å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
        if (readOnlyModeSection) readOnlyModeSection.style.display = 'none';
        if (viewingSection) viewingSection.style.display = 'block';
        if (viewOtherSection) viewOtherSection.style.display = 'none';
      } else {
        // é€šå¸¸: èª­ã¿å–ã‚Šå°‚ç”¨ãƒˆã‚°ãƒ«ã‚’è¡¨ç¤ºã€é–²è¦§ä¸­ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã€å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        if (readOnlyModeSection) readOnlyModeSection.style.display = 'block';
        if (viewingSection) viewingSection.style.display = 'none';
        if (viewOtherSection) viewOtherSection.style.display = 'block';
      }
    }

    // ===== ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ =====
    let exportInProgress = false;

    // ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
    async function showDriveExportDialog() {
      const modal = document.getElementById('driveExportModal');
      const loginPrompt = document.getElementById('exportLoginPrompt');
      const existsPrompt = document.getElementById('exportExistsPrompt');
      const exportProgress = document.getElementById('exportProgress');
      const exportResult = document.getElementById('exportResult');
      const startBtn = document.getElementById('exportStartBtn');
      const overwriteBtn = document.getElementById('exportOverwriteBtn');
      const exportFileName = document.getElementById('exportFileName');

      // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      loginPrompt.style.display = 'none';
      existsPrompt.style.display = 'none';
      exportProgress.style.display = 'none';
      exportResult.style.display = 'none';
      startBtn.style.display = 'inline-block';
      startBtn.disabled = false;
      startBtn.textContent = 'â˜ï¸ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ';
      overwriteBtn.style.display = 'none';

      // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¡¨ç¤º
      if (window.googleDriveSync) {
        exportFileName.textContent = window.googleDriveSync.getExportFileName();
      }

      // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
      if (!window.googleDriveSync || !window.googleDriveSync.getSignedIn()) {
        loginPrompt.style.display = 'block';
        startBtn.disabled = true;
        startBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„';
      }

      modal.style.display = 'block';
    }

    // ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’éè¡¨ç¤º
    function hideDriveExportDialog() {
      const modal = document.getElementById('driveExportModal');
      if (exportInProgress) {
        if (!confirm('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’ä¸­æ–­ã—ã¾ã™ã‹ï¼Ÿ')) {
          return;
        }
        exportInProgress = false;
      }
      modal.style.display = 'none';
    }

    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’å®Ÿè¡Œ
    async function executeExport(overwrite) {
      if (exportInProgress) return;

      if (!window.googleDriveSync || !window.googleDriveSync.getSignedIn()) {
        alert('Googleã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
        return;
      }

      exportInProgress = true;

      const loginPrompt = document.getElementById('exportLoginPrompt');
      const existsPrompt = document.getElementById('exportExistsPrompt');
      const exportProgress = document.getElementById('exportProgress');
      const exportProgressBar = document.getElementById('exportProgressBar');
      const exportProgressText = document.getElementById('exportProgressText');
      const exportResult = document.getElementById('exportResult');
      const startBtn = document.getElementById('exportStartBtn');
      const overwriteBtn = document.getElementById('exportOverwriteBtn');
      const cancelBtn = document.getElementById('exportCancelBtn');

      // UIã‚’æ›´æ–°
      loginPrompt.style.display = 'none';
      existsPrompt.style.display = 'none';
      exportProgress.style.display = 'block';
      exportResult.style.display = 'none';
      startBtn.disabled = true;
      overwriteBtn.style.display = 'none';
      cancelBtn.textContent = 'ä¸­æ–­';

      try {
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚’æ›´æ–°
        exportProgressBar.style.width = '30%';
        exportProgressText.textContent = 'ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ä¸­...';

        await new Promise(resolve => setTimeout(resolve, 300));

        exportProgressBar.style.width = '60%';
        exportProgressText.textContent = 'Googleãƒ‰ãƒ©ã‚¤ãƒ–ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Ÿè¡Œ
        const result = await window.googleDriveSync.exportToFile(overwrite);

        if (!result.success) {
          if (result.message === 'exists') {
            // ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆ
            exportProgress.style.display = 'none';
            existsPrompt.style.display = 'block';

            const existingFileInfo = document.getElementById('existingFileInfo');
            const modifiedDate = new Date(result.existingFile.modifiedTime);
            existingFileInfo.textContent = `æœ€çµ‚æ›´æ–°: ${modifiedDate.toLocaleString('ja-JP')}`;

            startBtn.style.display = 'none';
            overwriteBtn.style.display = 'inline-block';
            cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
            exportInProgress = false;
            return;
          } else {
            throw new Error(result.message);
          }
        }

        // æˆåŠŸ
        exportProgressBar.style.width = '100%';
        exportProgressText.textContent = 'å®Œäº†ï¼';

        await new Promise(resolve => setTimeout(resolve, 500));

        exportProgress.style.display = 'none';
        exportResult.style.display = 'block';
        exportResult.style.background = '#d4edda';
        exportResult.style.border = '1px solid #c3e6cb';
        exportResult.style.color = '#155724';

        const actionText = result.message === 'updated' ? 'ä¸Šæ›¸ãä¿å­˜' : 'æ–°è¦ä½œæˆ';
        exportResult.innerHTML = `
          <strong>âœ… ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ${actionText === 'ä¸Šæ›¸ãä¿å­˜' ? 'ï¼ˆä¸Šæ›¸ãï¼‰' : ''}å®Œäº†ï¼</strong><br>
          <span style="font-size:0.85em;">
            ãƒ•ã‚¡ã‚¤ãƒ«å: ${result.fileName}<br>
            ã‚«ãƒ¼ãƒ‰æ‰€æŒæ•°: ${result.stats.cardCount}ä»¶<br>
            ãƒ‡ãƒƒã‚­: ${result.stats.deckCount}ä»¶<br>
            ãƒã‚¤ãƒ³ãƒ€ãƒ¼: ${result.stats.binderCount}ä»¶
          </span>
        `;

        startBtn.style.display = 'none';
        overwriteBtn.style.display = 'none';
        cancelBtn.textContent = 'é–‰ã˜ã‚‹';

      } catch (error) {
        console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);

        exportProgress.style.display = 'none';
        exportResult.style.display = 'block';
        exportResult.style.background = '#f8d7da';
        exportResult.style.border = '1px solid #f5c6cb';
        exportResult.style.color = '#721c24';
        exportResult.innerHTML = `<strong>âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¤±æ•—</strong><br>${error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`;

        startBtn.disabled = false;
        cancelBtn.textContent = 'é–‰ã˜ã‚‹';
      } finally {
        exportInProgress = false;
      }
    }

    // Googleãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®å¤‰æ›´ã‚’ç›£è¦–
    window.addEventListener('googleSignInChange', function(e) {
      const driveExportBtn = document.getElementById('driveExportBtn');
      const loginPrompt = document.getElementById('exportLoginPrompt');
      const startBtn = document.getElementById('exportStartBtn');

      if (e.detail.signedIn) {
        // ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸ
        if (driveExportBtn) {
          driveExportBtn.style.opacity = '1';
        }
        if (loginPrompt) {
          loginPrompt.style.display = 'none';
        }
        if (startBtn) {
          startBtn.disabled = false;
          startBtn.textContent = 'â˜ï¸ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ';
        }
      } else {
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ãŸ
        if (loginPrompt && loginPrompt.closest('#driveExportModal').style.display !== 'none') {
          loginPrompt.style.display = 'block';
        }
        if (startBtn) {
          startBtn.disabled = true;
          startBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„';
        }
      }
    });

    // å…¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤æ©Ÿèƒ½
    async function clearAllCache() {
      if (!confirm('å…¨ã¦ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ»ç”»åƒã‚­ãƒ£ãƒƒã‚·ãƒ¥\nãƒ»ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥\nãƒ»ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸\n\nå‰Šé™¤å¾Œã¯å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å†ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚')) {
        return;
      }

      const clearBtn = document.getElementById('clearCacheBtn');
      const originalText = clearBtn.textContent;
      
      try {
        clearBtn.disabled = true;
        clearBtn.textContent = 'å‰Šé™¤ä¸­...';
        
        let deletedCaches = 0;
        let deletedStorage = 0;
        
        // 1. Service Worker ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
        const cacheNames = await caches.keys();
        for (const cacheName of cacheNames) {
          await caches.delete(cacheName);
          deletedCaches++;
        }
        
        // 2. localStorage ã‚’å‰Šé™¤ï¼ˆãƒã‚¤ãƒ³ãƒ€ãƒ¼é–¢é€£ã¯ä¿è­·ï¼‰
        const localStorageKeys = Object.keys(localStorage);
        const appKeys = localStorageKeys.filter(key => 
          (key.includes('card') || key.includes('deck') || 
          key.includes('Data') || key.includes('darkMode') || key.includes('version') ||
          key.includes('filter') || key.includes('view') || key.includes('owned') ||
          key.startsWith('count_')) &&
          // ãƒã‚¤ãƒ³ãƒ€ãƒ¼é–¢é€£ã®ã‚­ãƒ¼ã¯é™¤å¤–
          !key.includes('binder') && !key.includes('Binder')
        );
        
        appKeys.forEach(key => {
          localStorage.removeItem(key);
          deletedStorage++;
        });
        
        clearBtn.textContent = 'âœ… å‰Šé™¤å®Œäº†';
        
        alert(`å…¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼\n\nå‰Šé™¤ã—ãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥: ${deletedCaches}å€‹\nå‰Šé™¤ã—ãŸãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿: ${deletedStorage}å€‹\n\næ¬¡å›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å†ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚`);
        
        // UIã‚’ãƒªã‚»ãƒƒãƒˆ
        setTimeout(() => {
          clearBtn.textContent = originalText;
          clearBtn.disabled = false;
        }, 2000);
        
      } catch (error) {
        clearBtn.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼';
        alert(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š${error.message}`);
        
        setTimeout(() => {
          clearBtn.textContent = originalText;
          clearBtn.disabled = false;
        }, 2000);
      }
    }
  </script>
  <!-- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ç®¡ç† -->
  <script src="js/offline-utils.js"></script>
  <!-- å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ -->
  <script src="js/utils.js"></script>
  <!-- Google DriveåŒæœŸ -->
  <script src="config/google-client-id.js"></script>
  <script src="js/google-drive-sync.js"></script>
  <script>
    // Google DriveåŒæœŸUIã‚’åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      // ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ã«Google Drive UIã‚’è¿½åŠ 
      const container = document.querySelector('.container');
      if (container) {
        // ã‚¿ã‚¤ãƒˆãƒ«ã®ç›´å¾Œã«UIã‚’æŒ¿å…¥ã™ã‚‹ãŸã‚ã®ãƒ˜ãƒƒãƒ€ãƒ¼è¦ç´ ã‚’ä½œæˆ
        const h1 = container.querySelector('h1');
        if (h1) {
          const driveHeader = document.createElement('div');
          driveHeader.className = 'google-drive-header';
          driveHeader.style.cssText = 'display: flex; justify-content: center; align-items: center; margin-bottom: 20px;';
          h1.parentNode.insertBefore(driveHeader, h1.nextSibling);
          window.initializeGoogleDriveSync('.google-drive-header');
        }
      }
    });
  </script>
</body>
</html>
